<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Model.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Model.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var jsonp = require('browser-jsonp');

var pubsub = require('./modules/PubSub');
var each = require('./modules/utils').each;
var keys = require('./modules/utils').keys;
var is = require('./modules/utils').is;
var getIndex = require('./modules/utils').getIndex;
var extendProto = require('./modules/extendProto');
var assign = require('./modules/utils').assign;
var isArray = require('./modules/utils').isArray;
var isObject = require('./modules/utils').isObject;

/**
 * The Model class is inspired on the Backbone.Model class, with setters, 
 * getters, pubsub and a very basic AJAX layer (JSONP).
 *
 * @example
 * var model = new Model({
 *   recorderId: 'abc',
 *   duration: 30,
 *   H264Recording: true
 * });
 *
 * model.set('net_connection', 'success');
 * model.get('duration') // 30
 * 
 * @author  Ron Jansen [ron@flipbase.com]
 * @copyright Flipbase 2015
 * @class Model
 * @classdesc This is a class description
 */

function Model (options) {

  // Assign default properties to the attributes object
  assign(this.attributes, this.defaults);
 
  // Add the mixins to the current object
  this._previousAttributes = {};
  this._changedAttributes;

  this.initialize.call(this, options);
}

Model.prototype = {

  urlRoot: '',

  // Every instance will get an '_id' property
  attributes: {
    _id: null
  },

  _previousAttributes: {},

  initialize: function(options) {},

  /** 
   * @return {Boolean} true if _id is null
   */
  isNew: function () {
    return (this.attributes._id === null);
  },

  _dirty: false,

  isDirty: function () {
    return !!this._dirty;
  },

  fetch: function (options) {
    options = options || {};
    options.method = 'GET';
    this.send(options);
  },

  save: function (options) {
    options = options || {};
    options.method = 'POST';
    this.send(options, true);
  },

  send: function (options, parse) {
    if (parse === null) parse = true;
    var model = this;
    // Save provided success handler so we can override it with our own
    var success = options.success || function (){};
    
    options.success = function (res, req) {
      // Use custom parse method if attributes needs to be parsed
      // Parse the model before using the success handler, so the model
      // is not dirty anymore when the callback is triggered
      if (parse) model.parse(model, res);
      
      // Reset model isDirty() return value
      model._dirty = false;

      success(res, req); 
    };
    
    options.data = this.attributes;

    // append url with _id if one exists
    options.url = this.urlRoot + (!this.isNew) ? '/' + this.get('_id') : '/';
    jsonp(options);
  },


  parse: function (model, response) {
    each(keys(response), function(key) {
      if (model.attributes.hasOwnProperty(key)) 
        model.set(key, response[key]);
    });
  },

  /**
   * @param  {string} attr
   * @return {object}
   */
  get: function (attr, val, options) {
    return (this.attributes[attr] || undefined);
  },

  /**
   * Get previous value from a certain attribute.
   * 
   * @param  {string} attr key to fetch attribute
   * @returns {object}     attribute value
   */
  previous: function (attr) {
    if (!this._previousAttributes || !this._previousAttributes[attr]) return null;
    
    return this._previousAttributes[attr];
  },

  /**
   * @param {String|Object} attr key or object
   * @param {Object}        val  value to set the attr to
   */
  set: function (attr, val, options) {
    var error;
    options = options || {};

    // Copy all the attributes before applying the change
    assign(this._previousAttributes, this.attributes);

    // Validate before change the setting
    // if (!options.silent &amp;&amp; typeof attr === 'string') 
      // error = this.validateAttr(attr, val) || null;

    // If no validation error is returned apply the change
    if (!error) {
      if (isObject(this.attributes[attr])) {
        assign(this.attributes[attr], val);
      } else if (isArray(this.attributes[attr])) {
        this.attributes[attr].push(val);
      } else {
        this.attributes[attr] = val;
      }
    }

    // Set model to dirty if property has been changed
    if (this.hasChanged(attr)) {
      this._dirty = true;
    }

    // Broadcast events about the changed attribute
    if (typeof attr === 'string') {
      this.publish('change:' + attr, this, val);
    }

    // Broadcast global event 
    this.publish('change', this);
  },

  hasChanged: function (attr, val) {
    return (this._previousAttributes[attr] !== this.attributes[attr]);
  },

  // Create local pubsub store
  _topics: {},

  publish: function (evnt, model, val) {
    pubsub.publish(evnt, this._topics, model, val);
  },

  subscribe: function(evnt, fn, context) {
    var self = this;
    var evnts = evnt.split(', ') || [evnt];

    each(evnts, function (evt) {
      pubsub.subscribe(evt, fn, context, self._topics);
    });
  },

  unsubscribe: function () {},

};

Model.extend = extendProto;

module.exports = Model;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-modules_base64.html">modules/base64</a></li><li><a href="module-modules_browser.html">modules/browser</a></li><li><a href="module-modules_cookie.html">modules/cookie</a></li><li><a href="module-modules_DOM.html">modules/DOM</a></li><li><a href="module-modules_events.html">modules/events</a></li><li><a href="module-modules_LogX.html">modules/LogX</a></li><li><a href="module-modules_LogX-console-transport.html">modules/LogX-console-transport</a></li><li><a href="module-modules_LogX-jsonp-transport.html">modules/LogX-jsonp-transport</a></li><li><a href="module-modules_PubSub.html">modules/PubSub</a></li><li><a href="module-modules_utils.html">modules/utils</a></li></ul><h3>Classes</h3><ul><li><a href="Component.html">Component</a></li><li><a href="Model.html">Model</a></li></ul><h3>Namespaces</h3><ul><li><a href="global.html#Flipbase">Flipbase</a></li><li><a href="module-modules_utils-utils.html">utils</a></li></ul><h3>Mixins</h3><ul><li><a href="extendProto.html">extendProto</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-getting-started.html">getting-started</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Sat Oct 24 2015 14:16:34 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
